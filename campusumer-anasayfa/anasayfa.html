<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Campus Summer</title>
    <link rel="stylesheet" href="anasayfa.css" />
  </head>
  <body>
    <header class="header">
      <div class="container">
        <div class="logo">
          <img src="2.3.logo.png" alt="Campus Summer Logo" />
          <span>Campus Summer</span>
        </div>

        <nav class="nav-menu">
          <div class="nav-item">
            <a href="anasayfa.html" class="nav-link active">Anasayfa</a>
          </div>
          <div class="nav-item">
            <a href="../Dersler/dersler.html" class="nav-link">Dersler</a>
          </div>
          <div class="nav-item">
            <a href="../Ãœniversiteler/Ãœniversitler.html" class="nav-link"
              >Ãœniversiteler</a
            >
          </div>
          <div class="nav-item">
            <a href="../FakÃ¼lteler/fakÃ¼lteler.html" class="nav-link"
              >FakÃ¼lteler</a
            >
          </div>
          <div class="nav-item">
            <a href="../HakkÄ±mÄ±zda/HakkÄ±mÄ±zda.html" class="nav-link"
              >HakkÄ±mÄ±zda</a
            >
          </div>
          <div class="nav-item">
            <a href="../Ä°letiÅŸim/iletisim.html" class="nav-link">Ä°letiÅŸim</a>
          </div>
        </nav>

        <!-- Profil BÃ¶lÃ¼mÃ¼ -->
        <div class="profile-section">
          <div class="profile-avatar" id="profileToggle">
            <span id="avatarInitials">?</span>
          </div>
          <div class="profile-dropdown" id="profileDropdown">
            <div class="profile-header">
              <div class="profile-avatar-large">
                <span id="avatarInitialsLarge">?</span>
              </div>
              <div class="profile-info">
                <h4 id="profileName">KullanÄ±cÄ±</h4>
                <p id="profileEmail">email@example.com</p>
              </div>
            </div>
            <div class="profile-details">
              <div class="profile-detail-item">
                <span class="detail-label">KullanÄ±cÄ± Tipi:</span>
                <span class="detail-value" id="profileType">-</span>
              </div>
              <div class="profile-detail-item">
                <span class="detail-label">Okul NumarasÄ±:</span>
                <span class="detail-value" id="profileStudentNumber">-</span>
              </div>
            </div>
            <div class="profile-actions">
              <button class="btn-edit-profile" id="editProfileBtn">âœï¸ Profil DÃ¼zenle</button>
              <button class="btn-logout" id="logoutBtn">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <section class="hero" id="home">
      <div class="container">
        <div class="hero-content">
          <h1>TÃ¼rkiye'nin En KapsamlÄ± Yaz Dersleri Platformu</h1>
          <p>200+ Ã¼niversiteden binlerce yaz dersi seÃ§eneÄŸi tek platformda.</p>
          <div class="hero-stats">
            <div class="stat">
              <div class="stat-number">200+</div>
              <div class="stat-label">Ãœniversite</div>
            </div>
            <div class="stat">
              <div class="stat-number">500+</div>
              <div class="stat-label">Yaz Dersi</div>
            </div>
            <div class="stat">
              <div class="stat-number">50K+</div>
              <div class="stat-label">Mutlu Ã–ÄŸrenci</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="search-section" id="search">
      <div class="container">
        <div class="search-container">
          <h2 class="search-title">Ä°deal Yaz Dersini Bul</h2>
          <form class="search-form" id="searchForm">
            <div class="form-group">
              <label for="university">Ãœniversite</label>
              <select id="university">
                <option value="">Ãœniversite SeÃ§in</option>
              </select>
            </div>

            <div class="form-group">
              <label for="faculty">FakÃ¼lte</label>
              <select id="faculty">
                <option value="">FakÃ¼lte SeÃ§in</option>
              </select>
            </div>

            <div class="form-group">
              <label for="language">Ders Dili</label>
              <select id="language">
                <option value="">Dil SeÃ§in</option>
                <option value="Matematik">Matematik</option>
                <option value="Kimya">Kimya</option>
                <option value="Bilgisayar Programlama">Bilgisayar Programlama</option>
                <option value="Fizik">Fizik</option>
                <option value="Ä°ngilizce">Ä°ngilizce</option>
                <option value="Ä°statistik">Ä°statistik</option>
              </select>
            </div>

            <div class="form-group">
              <label for="semester">DÃ¶nem</label>
              <select id="semester">
                <option value="">DÃ¶nem SeÃ§in</option>
                <option value="summer-2025">Yaz 2025</option>
                <option value="fall-2025">GÃ¼z 2025</option>
              </select>
            </div>

            <button type="submit" class="search-button">ğŸ” Ders Ara</button>
          </form>
        </div>
      </div>
    </section>

    <!-- Favori Dersler Section -->
    <section class="favorite-courses-section" id="favoriteCourses" style="display: none;">
      <div class="container">
        <div class="section-header">
          <h2>â­ Favori Derslerim</h2>
          <p>SeÃ§tiÄŸiniz yaz okulu dersleri</p>
        </div>
        <div class="favorite-courses-grid" id="favoriteCoursesGrid">
          <!-- Favori dersler dinamik olarak yÃ¼klenecek -->
        </div>
      </div>
    </section>

    <!-- Profil DÃ¼zenleme ModalÄ± -->
    <div class="modal-overlay" id="editProfileModal" style="display: none;">
      <div class="modal-container">
        <div class="modal-header">
          <h2>Profil DÃ¼zenle</h2>
          <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <form class="modal-form" id="editProfileForm">
          <div class="form-row">
            <div class="form-group">
              <label for="editFirstName">Ad</label>
              <input
                type="text"
                id="editFirstName"
                name="firstName"
                required
              />
            </div>
            <div class="form-group">
              <label for="editLastName">Soyad</label>
              <input
                type="text"
                id="editLastName"
                name="lastName"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="editEmail">E-posta</label>
            <input type="email" id="editEmail" name="email" required />
          </div>

          <div class="form-group">
            <label for="editStudentNumber">Okul NumarasÄ± / KullanÄ±cÄ± AdÄ±</label>
            <input
              type="text"
              id="editStudentNumber"
              name="studentNumber"
              readonly
            />
            <small style="color: #666;">Bu alan deÄŸiÅŸtirilemez</small>
          </div>

          <div class="password-section">
            <h3 style="font-size: 1.2rem; color: #333; margin-bottom: 15px;">
              Åifre DeÄŸiÅŸtir (Opsiyonel)
            </h3>
            <div class="form-group">
              <label for="editCurrentPassword">Mevcut Åifre</label>
              <input
                type="password"
                id="editCurrentPassword"
                name="currentPassword"
                placeholder="BoÅŸ bÄ±rakÄ±labilir"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editNewPassword">Yeni Åifre</label>
                <input
                  type="password"
                  id="editNewPassword"
                  name="newPassword"
                  placeholder="BoÅŸ bÄ±rakÄ±labilir"
                />
              </div>
              <div class="form-group">
                <label for="editConfirmPassword">Åifre Tekrar</label>
                <input
                  type="password"
                  id="editConfirmPassword"
                  name="confirmPassword"
                  placeholder="BoÅŸ bÄ±rakÄ±labilir"
                />
              </div>
            </div>
          </div>

          <div id="editErrorMessage" class="edit-error-message"></div>
          <div id="editSuccessMessage" class="edit-success-message"></div>

          <div class="modal-actions">
            <button type="button" class="btn-cancel" id="cancelEdit">
              Ä°ptal
            </button>
            <button type="submit" class="btn-save">Kaydet</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const API_URL = `${window.location.origin}/api`;
      let currentUser = null;
      let currentToken = null;

      // KullanÄ±cÄ± bilgilerini yÃ¼kle
      function loadUserProfile() {
        const user = JSON.parse(localStorage.getItem("user"));
        const token = localStorage.getItem("token");

        if (!user || !token) {
          // GiriÅŸ yapmamÄ±ÅŸ kullanÄ±cÄ±yÄ± giriÅŸ sayfasÄ±na yÃ¶nlendir
          window.location.href = "../Ã¶ÄŸrenci-giriÅŸ/Ã¶ÄŸrenci-giriÅŸ.html";
          return;
        }

        currentUser = user;
        currentToken = token;

        // Profil bilgilerini doldur
        const initials =
          (user.firstName?.charAt(0) || "") + (user.lastName?.charAt(0) || "");
        document.getElementById("avatarInitials").textContent =
          initials.toUpperCase() || "?";
        document.getElementById("avatarInitialsLarge").textContent =
          initials.toUpperCase() || "?";
        document.getElementById("profileName").textContent = `${
          user.firstName || ""
        } ${user.lastName || ""}`;
        document.getElementById("profileEmail").textContent = user.email || "";
        document.getElementById("profileType").textContent =
          user.userType === "student" ? "Ã–ÄŸrenci" : "Akademisyen";
        document.getElementById("profileStudentNumber").textContent =
          user.studentNumber || user.username || "-";
        
        // Favori dersleri yÃ¼kle (sadece Ã¶ÄŸrenciler iÃ§in)
        if (user.userType === "student") {
          loadFavoriteCourses();
        }
      }

      // Ãœniversiteleri yÃ¼kle
      async function loadUniversities() {
        try {
          const response = await fetch(`${API_URL}/universities`);
          const data = await response.json();
          
          if (data.success && data.universities) {
            const select = document.getElementById("university");
            select.innerHTML = '<option value="">Ãœniversite SeÃ§in</option>';
            
            data.universities.forEach(uni => {
              const option = document.createElement("option");
              option.value = uni.id;
              option.textContent = uni.name;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error("Ãœniversiteler yÃ¼klenirken hata:", error);
        }
      }

      // FakÃ¼lteleri yÃ¼kle
      async function loadFaculties() {
        try {
          const response = await fetch(`${API_URL}/faculties`);
          const data = await response.json();
          
          if (data.success && data.faculties) {
            const select = document.getElementById("faculty");
            select.innerHTML = '<option value="">FakÃ¼lte SeÃ§in</option>';
            
            data.faculties.forEach(faculty => {
              const option = document.createElement("option");
              option.value = faculty.id;
              option.textContent = faculty.name;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error("FakÃ¼lteler yÃ¼klenirken hata:", error);
        }
      }

      // Favori dersleri yÃ¼kle
      async function loadFavoriteCourses() {
        try {
          const response = await fetch(`${API_URL}/favorites`, {
            headers: {
              'Authorization': `Bearer ${currentToken}`
            }
          });
          const data = await response.json();
          
          if (data.success && data.favorites && data.favorites.length > 0) {
            document.getElementById("favoriteCourses").style.display = "block";
            displayFavoriteCourses(data.favorites);
          }
        } catch (error) {
          console.error("Favori dersler yÃ¼klenirken hata:", error);
        }
      }

      // Favori dersleri gÃ¶ster
      function displayFavoriteCourses(favorites) {
        const grid = document.getElementById("favoriteCoursesGrid");
        grid.innerHTML = "";

        favorites.forEach(favorite => {
          const card = document.createElement("div");
          card.className = "favorite-course-card";
          card.innerHTML = `
            <div class="course-header">
              <h3>${favorite.course_name}</h3>
              <button class="remove-favorite-btn" onclick="removeFavorite(${favorite.id})" title="Favorilerden KaldÄ±r">
                âŒ
              </button>
            </div>
            <div class="course-info">
              <p><strong>Ders Kodu:</strong> ${favorite.course_code || '-'}</p>
              <p><strong>Kategori:</strong> ${favorite.category || '-'}</p>
              <p><strong>Akademisyen:</strong> ${favorite.academician_name || 'BelirtilmemiÅŸ'}</p>
            </div>
            <div class="course-meta">
              <span class="added-date">ğŸ“… Eklenme: ${new Date(favorite.favorited_at || favorite.created_at).toLocaleDateString('tr-TR')}</span>
            </div>
          `;
          grid.appendChild(card);
        });
      }

      // Favoriden kaldÄ±r
      async function removeFavorite(courseId) {
        if (!confirm("Bu dersi favorilerden kaldÄ±rmak istediÄŸinize emin misiniz?")) {
          return;
        }

        try {
          const response = await fetch(`${API_URL}/favorites/${courseId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${currentToken}`
            }
          });

          const data = await response.json();

          if (data.success) {
            alert("Ders favorilerden kaldÄ±rÄ±ldÄ±!");
            loadFavoriteCourses();
          } else {
            alert(data.message || "Bir hata oluÅŸtu");
          }
        } catch (error) {
          console.error("Favori kaldÄ±rma hatasÄ±:", error);
          alert("Bir hata oluÅŸtu");
        }
      }

      // Arama formu submit
      document.getElementById("searchForm").addEventListener("submit", function(e) {
        e.preventDefault();
        
        const university = document.getElementById("university").value;
        const faculty = document.getElementById("faculty").value;
        const category = document.getElementById("language").value;
        
        // Dersler sayfasÄ±na yÃ¶nlendir (query parametreleriyle)
        let url = "../Dersler/dersler.html?";
        const params = [];
        
        if (university) params.push(`university=${university}`);
        if (faculty) params.push(`faculty=${faculty}`);
        if (category) params.push(`category=${encodeURIComponent(category)}`);
        
        url += params.join("&");
        window.location.href = url;
      });

      // Profil dropdown toggle
      document
        .getElementById("profileToggle")
        .addEventListener("click", function (e) {
          e.stopPropagation();
          const dropdown = document.getElementById("profileDropdown");
          dropdown.classList.toggle("active");
        });

      // Dropdown dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
      document.addEventListener("click", function (e) {
        const dropdown = document.getElementById("profileDropdown");
        const profileSection = document.querySelector(".profile-section");
        if (!profileSection.contains(e.target)) {
          dropdown.classList.remove("active");
        }
      });

      // Ã‡Ä±kÄ±ÅŸ yap
      document
        .getElementById("logoutBtn")
        .addEventListener("click", function () {
          localStorage.removeItem("token");
          localStorage.removeItem("user");
          // Ana giriÅŸ sayfasÄ±na yÃ¶nlendir
          const basePath = window.location.pathname.split('/campusumer-anasayfa')[0];
          window.location.href = basePath + '/website-giri%C5%9F-sayfas%C4%B1/website-giri%C5%9F-sayfas%C4%B1.html';
        });

      // Profil DÃ¼zenleme Modal Ä°ÅŸlemleri
      const modal = document.getElementById("editProfileModal");
      const editProfileBtn = document.getElementById("editProfileBtn");
      const closeModalBtn = document.getElementById("closeModal");
      const cancelEditBtn = document.getElementById("cancelEdit");
      const editProfileForm = document.getElementById("editProfileForm");

      // Modal aÃ§ma
      editProfileBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        const user = JSON.parse(localStorage.getItem("user"));
        if (user) {
          // Form alanlarÄ±nÄ± doldur
          document.getElementById("editFirstName").value = user.firstName || "";
          document.getElementById("editLastName").value = user.lastName || "";
          document.getElementById("editEmail").value = user.email || "";
          document.getElementById("editStudentNumber").value = 
            user.studentNumber || user.username || "";
          
          // Åifre alanlarÄ±nÄ± temizle
          document.getElementById("editCurrentPassword").value = "";
          document.getElementById("editNewPassword").value = "";
          document.getElementById("editConfirmPassword").value = "";

          // MesajlarÄ± temizle
          document.getElementById("editErrorMessage").style.display = "none";
          document.getElementById("editSuccessMessage").style.display = "none";

          modal.style.display = "flex";
          // Dropdown'u kapat
          document.getElementById("profileDropdown").classList.remove("active");
        }
      });

      // Modal kapama fonksiyonlarÄ±
      function closeModal() {
        modal.style.display = "none";
      }

      closeModalBtn.addEventListener("click", closeModal);
      cancelEditBtn.addEventListener("click", closeModal);

      // Modal dÄ±ÅŸÄ±na tÄ±klandÄ±ÄŸÄ±nda kapat
      modal.addEventListener("click", function (e) {
        if (e.target === modal) {
          closeModal();
        }
      });

      // Profil gÃ¼ncelleme formu
      editProfileForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const errorDiv = document.getElementById("editErrorMessage");
        const successDiv = document.getElementById("editSuccessMessage");
        errorDiv.style.display = "none";
        successDiv.style.display = "none";

        const user = JSON.parse(localStorage.getItem("user"));
        const token = localStorage.getItem("token");

        if (!user || !token) {
          errorDiv.textContent = "Oturum bilgisi bulunamadÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.";
          errorDiv.style.display = "block";
          return;
        }

        // Form verilerini al
        const firstName = document.getElementById("editFirstName").value.trim();
        const lastName = document.getElementById("editLastName").value.trim();
        const email = document.getElementById("editEmail").value.trim();
        const currentPassword = document.getElementById("editCurrentPassword").value;
        const newPassword = document.getElementById("editNewPassword").value;
        const confirmPassword = document.getElementById("editConfirmPassword").value;

        // Åifre doÄŸrulamasÄ±
        if (newPassword || confirmPassword) {
          if (!currentPassword) {
            errorDiv.textContent = "Åifre deÄŸiÅŸtirmek iÃ§in mevcut ÅŸifrenizi girmelisiniz.";
            errorDiv.style.display = "block";
            return;
          }
          if (newPassword !== confirmPassword) {
            errorDiv.textContent = "Yeni ÅŸifreler eÅŸleÅŸmiyor.";
            errorDiv.style.display = "block";
            return;
          }
          if (newPassword.length < 6) {
            errorDiv.textContent = "Yeni ÅŸifre en az 6 karakter olmalÄ±dÄ±r.";
            errorDiv.style.display = "block";
            return;
          }
        }

        // API isteÄŸi iÃ§in veri hazÄ±rla
        const updateData = {
          firstName,
          lastName,
          email,
        };

        if (newPassword) {
          updateData.currentPassword = currentPassword;
          updateData.newPassword = newPassword;
        }

        try {
          const API_URL = `${window.location.origin}/api`;
          const endpoint = `${API_URL}/auth/profile/update`;

          const response = await fetch(endpoint, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(updateData),
          });

          const data = await response.json();

          if (response.ok && data.success) {
            successDiv.textContent = "Profil baÅŸarÄ±yla gÃ¼ncellendi!";
            successDiv.style.display = "block";

            // LocalStorage'Ä± gÃ¼ncelle
            const updatedUser = { ...user, ...updateData };
            delete updatedUser.currentPassword;
            delete updatedUser.newPassword;
            localStorage.setItem("user", JSON.stringify(updatedUser));

            // Profil bilgilerini yeniden yÃ¼kle
            setTimeout(() => {
              loadUserProfile();
              closeModal();
            }, 1500);
          } else {
            errorDiv.textContent = data.message || "Profil gÃ¼ncellenirken bir hata oluÅŸtu.";
            errorDiv.style.display = "block";
          }
        } catch (error) {
          console.error("Profil gÃ¼ncelleme hatasÄ±:", error);
          errorDiv.textContent = "Sunucuya baÄŸlanÄ±lamadÄ±. LÃ¼tfen tekrar deneyin.";
          errorDiv.style.display = "block";
        }
      });

      // Sayfa yÃ¼klendiÄŸinde profili ve diÄŸer verileri yÃ¼kle
      document.addEventListener("DOMContentLoaded", function() {
        loadUserProfile();
        loadUniversities();
        loadFaculties();
      });
    </script>

    <footer>
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h3>Campus Summer</h3>
            <p>
              TÃ¼rkiye'nin en kapsamlÄ± yaz dersleri takip platformu. Akademik
              hedeflerinize ulaÅŸmanÄ±n en kolay yolu.
            </p>
          </div>
          <div class="footer-section">
            <h3>HÄ±zlÄ± BaÄŸlantÄ±lar</h3>
            <a href="anasayfa.html">Ana Sayfa</a>
            <a href="../Ãœniversiteler/Ãœniversitler.html">Ãœniversiteler</a>
            <a href="../Dersler/dersler.html">Dersler</a>
            <a href="../HakkÄ±mÄ±zda/HakkÄ±mÄ±zda.html">HakkÄ±mÄ±zda</a>
          </div>
          <div class="footer-section">
            <h3>Destek</h3>
            <a href="../Ä°letiÅŸim/iletisim.html">Ä°letiÅŸim</a>
            <a href="../Gizlilik-politikasÄ±/gizlilikpolitikasÄ±.html"
              >Gizlilik PolitikasÄ±</a
            >
          </div>
          <div class="footer-section">
            <h3>Ä°letiÅŸim</h3>
            <p>ğŸ“§ atakan.baskir@std.hku.edu.tr</p>
            <p>ğŸ“ +90 506 536 1780</p>
            <p>ğŸ“ Gaziantep, TÃ¼rkiye</p>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 Campus Summer. TÃ¼m haklarÄ± saklÄ±dÄ±r.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
